---
description: FastAPI & Pydantic 规范
globs:
- '**/*.py'
alwaysApply: false
tags:
- python
- fastapi
version: 1.0.0
author: ai-coding-rules-team
---

# FastAPI & Pydantic 规范

## Pydantic 模型

### 模型组织

- 每个资源一个文件：user_schemas.py, post_schemas.py
- 分离请求和响应模型
- 在模型内部使用嵌套类定义子模型

```python
from pydantic import BaseModel, EmailStr, Field
from typing import Optional
from datetime import datetime

class UserBase(BaseModel):
    """用户基础模型"""
    username: str = Field(..., min_length=3, max_length=50)
    email: EmailStr

class UserCreate(UserBase):
    """用户创建请求"""
    password: str = Field(..., min_length=8)

class UserUpdate(BaseModel):
    """用户更新请求"""
    username: Optional[str] = Field(None, min_length=3, max_length=50)
    email: Optional[EmailStr] = None

class UserResponse(UserBase):
    """用户响应模型"""
    id: int
    is_active: bool
    created_at: datetime
    updated_at: datetime

    class Config:
        orm_mode = True
```

### 字段验证

- 使用 Field 提供详细的验证规则
- 必填字段使用 `...`
- 可选字段使用 `Optional` 或 `= None`

```python
from pydantic import BaseModel, Field

class Product(BaseModel):
    name: str = Field(..., min_length=1, max_length=100)
    price: float = Field(..., gt=0, description="价格必须大于 0")
    stock: int = Field(0, ge=0, description="库存必须大于等于 0")
    tags: list[str] = Field(default_factory=list)
```

## FastAPI 路由

### 路由结构

- 按功能模块组织路由
- 在 main.py 中包含路由
- 使用 APIRouter 管理路由

```python
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.ext.asyncio import AsyncSession

from app.api import deps
from app.schemas.user import UserCreate, UserResponse
from app.services.user_service import user_service

router = APIRouter(prefix="/users", tags=["users"])

@router.post("/", response_model=UserResponse, status_code=201)
async def create_user(
    user_in: UserCreate,
    db: AsyncSession = Depends(deps.get_db)
) -> UserResponse:
    """创建新用户"""
    user = await user_service.create(db, obj_in=user_in)
    return user
```

### 依赖注入

- 在 deps.py 中定义数据库会话依赖
- 实现认证依赖 get_current_user
- 使用 Depends 注入依赖

```python
from fastapi import Depends
from sqlalchemy.ext.asyncio import AsyncSession

async def get_db() -> AsyncGenerator[AsyncSession, None]:
    async with async_session_factory() as session:
        try:
            yield session
        finally:
            await session.close()
```

## 响应模型

### 标准响应格式

- 统一响应格式
- 包含 code, message, data 字段
- 提供分页响应模型

```python
from typing import Generic, TypeVar
from pydantic import BaseModel, Field

T = TypeVar('T')

class ResponseModel(BaseModel, Generic[T]):
    """标准响应模型"""
    code: int = Field(..., description="状态码")
    message: str = Field(..., description="消息")
    data: T | None = Field(None, description="响应数据")

class PaginatedResponse(BaseModel, Generic[T]):
    """分页响应模型"""
    total: int
    page: int
    page_size: int
    items: list[T]
```
