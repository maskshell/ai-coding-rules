---
description: Python 编码基础
globs:
- '**/*.py'
alwaysApply: false
tags:
- python
- fastapi
version: 1.0.0
author: ai-coding-rules-team
---

# Python 编码基础

## 类型注解

### 必需的类型注解

- 函数参数和返回值必须注解
- 类属性需要注解
- 使用 Pydantic 模型进行复杂数据验证

```python
from typing import Optional, List
from pydantic import BaseModel

# 好的例子
def get_user(user_id: int) -> Optional[UserResponse]:
    """获取用户信息"""
    pass

class UserCreate(BaseModel):
    """用户创建数据模型"""
    username: str
    email: str
    is_active: bool = True
    tags: List[str] = []
```

### 避免的类型

- 避免使用不恰当的 Optional
- 使用 Union 时优先使用 `|`

```python
# 好的例子
def process(data: str | None) -> int:
    pass

# 不好的例子
def process(data: Union[str, None]) -> int:
    pass
```

## 异步编程

### 统一使用 async/await

- 数据库操作使用 async
- HTTP 请求使用 async
- 缓存操作使用 async

```python
from sqlalchemy.ext.asyncio import AsyncSession

async def get_user_by_id(
    db: AsyncSession,
    user_id: int
) -> User | None:
    result = await db.execute(select(User).where(User.id == user_id))
    return result.scalars().first()
```

### 并发控制

- 使用 asyncio.Semaphore 限制并发
- 使用 asyncio.Lock 保护共享资源

## 错误处理

### 捕获具体异常

- 捕获最具体的异常类型
- 提供有用的错误信息
- 不吞掉异常，除非有明确处理

```python
try:
    user = await get_user_by_id(db, user_id)
except NoResultFound:
    raise HTTPException(
        status_code=404,
        detail="用户不存在"
    )
except Exception as e:
    logger.error(f"获取用户失败: {e}")
    raise HTTPException(
        status_code=500,
        detail="服务器错误"
    )
```

### FastAPI 错误

- 使用 HTTPException 返回错误
- 创建自定义异常类
- 使用异常处理器
