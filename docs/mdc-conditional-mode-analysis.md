# MDC 条件模式 Token 消耗分析

**文档版本**: 1.0.0  
**最后更新**: 2025-11-26  
**问题**: 使用条件模式的 MDC 文件能否达成减少 Token 消耗的目标？

---

## 一、问题背景

在改进计划中，我们讨论了两种实现双轨制规则的方案：

- **方案 A**：单文件双模式（使用条件模板语法）
- **方案 B**：双轨制文件（独立的完整版和精简版文件）

核心目标：**减少 Token 消耗 70-80%**

---

## 二、方案 A 的工作原理

### 2.1 文件结构

```yaml
---
description: "通用编程规范"
globs: ["**/*"]
alwaysApply: true
mode: auto  # auto | full | concise
---

# 通用编程规范

{% if mode == "full" %}
## 详细说明
（完整版内容：850 tokens）
...
{% else %}
## 核心规则
（精简版内容：180 tokens）
...
{% endif %}
```

### 2.2 预期行为

**理想情况**：

- 当 `mode: concise` 时，只读取精简版内容
- 当 `mode: full` 时，只读取完整版内容
- Token 消耗 = 精简版内容（180 tokens）✓

---

## 三、实际情况分析

### 3.1 Cursor 如何读取规则文件

**关键发现**：Cursor 在读取规则文件时，**不会执行模板语法**，而是：

1. **读取整个文件内容**（包括 frontmatter 和所有 Markdown 内容）
2. **将内容传递给 AI 模型**（作为上下文）
3. **AI 模型看到的是原始文件内容**，包括：
   - 模板语法（`{% if %}`, `{% else %}`, `{% endif %}`）
   - 完整版内容
   - 精简版内容

### 3.2 Token 消耗计算

**方案 A（条件模式 MDC）**：

```
总 Token = frontmatter + 模板语法 + 完整版内容 + 精简版内容

示例：
- frontmatter: ~50 tokens
- 模板语法: ~50 tokens
- 完整版内容: ~850 tokens
- 精简版内容: ~180 tokens
─────────────────────────────
总计: ~1,130 tokens ❌
```

**方案 B（双轨制文件）**：

```text
精简版文件 Token = frontmatter + 精简版内容

示例：
- frontmatter: ~50 tokens
- 精简版内容: ~180 tokens
─────────────────────────────
总计: ~230 tokens ✅
```

### 3.3 对比结果

| 方案 | Token 消耗 | 相比完整版 | 相比精简版 |
|-----|-----------|-----------|-----------|
| 完整版（基准） | 850 tokens | - | +470% |
| 方案 A（条件模式） | **1,130 tokens** | **+33%** ❌ | **+528%** ❌ |
| 方案 B（双轨制） | **230 tokens** | **-73%** ✅ | - |

**结论**：方案 A 不仅没有节省 Token，反而**增加了 33% 的消耗**！

---

## 四、为什么方案 A 失败？

### 4.1 根本原因

**Cursor 不支持模板语法执行**

- Cursor 是一个**静态文件读取器**，不是模板引擎
- 它不会在读取时执行 `{% if %}` 等模板语法
- 所有内容都会被原样传递给 AI 模型

### 4.2 类比说明

这就像在 Markdown 文件中写：

```markdown
<!-- 如果用户是管理员，显示这部分 -->
管理员专用内容

<!-- 否则显示这部分 -->
普通用户内容
```

**HTML 注释不会隐藏内容**，浏览器会显示所有内容。同样，**模板语法不会过滤内容**，AI 会看到所有内容。

### 4.3 如果 Cursor 支持模板语法会怎样？

**假设场景**：如果 Cursor 真的支持模板语法执行：

1. **需要构建步骤**：必须在读取前执行模板渲染
2. **失去实时性**：修改文件后需要重新构建
3. **增加复杂度**：需要维护构建脚本和构建产物
4. **兼容性问题**：不同版本的 Cursor 可能行为不一致

**但即使支持，方案 B 仍然更优**：

- 无需构建步骤
- 即时生效
- 结构清晰
- 易于维护

---

## 五、验证方法

### 5.1 实际测试

要验证这个结论，可以：

1. **创建测试文件**：

   ```yaml
   ---
   mode: concise
   ---
   
   {% if mode == "full" %}
   这是完整版内容（很长很长...）
   {% else %}
   这是精简版内容
   {% endif %}
   ```

2. **使用 Token 计算器**：

   ```bash
   uv run python scripts/calculate-tokens.py test.mdc
   ```

3. **观察结果**：
   - 如果 Token 数 = 精简版内容 → 模板语法生效 ✓
   - 如果 Token 数 = 全部内容 → 模板语法无效 ✗

### 5.2 预期结果

**预期**：Token 数 = 全部内容（模板语法 + 完整版 + 精简版）

**原因**：Cursor 不会执行模板语法，会读取整个文件。

---

## 六、正确的 Token 节省方法

### 6.1 内容精简（方案 B）

**Token 节省来自于内容优化，而非文件结构魔术**：

```markdown
【完整版 - 850 tokens】
### 组件命名规范
文件名应该使用 PascalCase（如 UserProfile.tsx）。这种命名方式在 React 社区已经成为标准实践，它有助于区分组件文件和普通工具函数文件。使用一致的命名约定能够让团队成员快速识别文件类型...

**原因**：PascalCase 命名法可以追溯到早期的编程惯例...
**示例**：（5个详细示例）
**注意事项**：（10个要点）
**边缘案例**：（5种情况）
**参考资源**：（15个链接）
```

```markdown
【精简版 - 180 tokens】
### 组件命名
- 文件名使用 PascalCase（如 `UserProfile.tsx`）
- 组件名与文件名保持一致

**示例**:
```tsx
// Good
export function UserProfile() { ... }
// Bad
export function user_profile() { ... }
```

**原因**：保持一致性，便于文件搜索和导入。

```

**Token 节省来源**：
- 删除解释性文字（-200 tokens）
- 精简示例数量 5→2 个（-150 tokens）
- 删除边缘案例（-100 tokens）
- 删除参考链接（-50 tokens）
- 压缩段落为紧凑列表（-100 tokens）
- **总计节省：670 tokens（79%）✓**

### 6.2 文件分离（方案 B）

**保持独立的完整版和精简版文件**：

```

full-rules/ide-layer/rulesets/01-general.md          (850 tokens)
.concise-rules/ide-layer/01-general.md               (180 tokens) ✓ AI 使用

```

**优势**：
- AI 只读取精简版文件（180 tokens）
- 人类可以查阅完整版文件（850 tokens）
- 无需构建步骤
- 即时生效

---

## 七、结论

### ✅ **方案 A（条件模式 MDC）不能达成减少 Token 消耗的目标**

**原因**：
1. Cursor 不支持模板语法执行
2. AI 会读取整个文件内容（包括模板语法、完整版、精简版）
3. Token 消耗反而增加 33%

### ✅ **方案 B（双轨制文件）能够达成减少 Token 消耗的目标**

**原因**：
1. AI 只读取精简版文件
2. Token 消耗减少 73-79%
3. 无需构建步骤，即时生效

### 📊 最终建议

**选择方案 B（双轨制文件）**，原因：

| 维度 | 方案 A | 方案 B | 推荐 |
|-----|--------|--------|------|
| Token 节省 | ❌ 失败（+33%） | ✅ 成功（-73%） | **方案 B** |
| 实现复杂度 | 高（需要构建） | 低（直接使用） | 方案 B |
| 实时性 | 延迟（需要构建） | 即时生效 | 方案 B |
| 维护成本 | 高 | 中 | 方案 B |

---

## 八、参考资料

- [改进计划 - 设计决策](./IMPROVEMENT_PLAN.md#设计决策选择方案-b)
- [技术栈选型建议](./tech-stack-recommendation.md)

---

**文档维护者**: AI Coding Rules 团队  
**反馈渠道**: GitHub Issues / Discussions

